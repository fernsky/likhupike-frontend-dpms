<div class="user-list-container">
  <!-- Header -->
  <div class="user-list-header">
    <h1>{{ "user.list.title" | transloco }}</h1>
    <button mat-raised-button color="primary" (click)="onCreateUser()">
      <mat-icon>add</mat-icon>
      {{ "user.list.createButton" | transloco }}
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-section" [formGroup]="filterForm">
    <mat-form-field appearance="outline">
      <mat-label>{{ "user.list.searchTerm" | transloco }}</mat-label>
      <input matInput formControlName="searchTerm" type="text" />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ "user.list.email" | transloco }}</mat-label>
      <input matInput formControlName="email" type="email" />
    </mat-form-field>

    <div class="ward-range">
      <mat-form-field appearance="outline">
        <mat-label>{{ "user.list.wardFrom" | transloco }}</mat-label>
        <input
          matInput
          type="number"
          formControlName="wardNumberFrom"
          min="1"
          max="33"
        />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>{{ "user.list.wardTo" | transloco }}</mat-label>
        <input
          matInput
          type="number"
          formControlName="wardNumberTo"
          min="1"
          max="33"
        />
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline">
      <mat-label>{{ "user.list.approvalStatus" | transloco }}</mat-label>
      <mat-select formControlName="isApproved">
        <mat-option [value]="null">{{
          "user.list.allStatuses" | transloco
        }}</mat-option>
        <mat-option [value]="true">{{
          "user.list.approved" | transloco
        }}</mat-option>
        <mat-option [value]="false">{{
          "user.list.notApproved" | transloco
        }}</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="date-range">
      <mat-form-field appearance="outline">
        <mat-label>{{ "user.list.createdAfter" | transloco }}</mat-label>
        <input
          matInput
          [matDatepicker]="afterPicker"
          formControlName="createdAfter"
          readonly
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="afterPicker"
        ></mat-datepicker-toggle>
        <mat-datepicker #afterPicker></mat-datepicker>
        <mat-error
          *ngIf="filterForm?.get('createdAfter')?.errors?.['matDatepickerMax']"
        >
          {{ "user.list.errors.dateRange" | transloco }}
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>{{ "user.list.createdBefore" | transloco }}</mat-label>
        <input
          matInput
          [matDatepicker]="beforePicker"
          formControlName="createdBefore"
          readonly
        />
        <mat-datepicker-toggle
          matSuffix
          [for]="beforePicker"
        ></mat-datepicker-toggle>
        <mat-datepicker #beforePicker></mat-datepicker>
        <mat-error
          *ngIf="filterForm?.get('createdBefore')?.errors?.['matDatepickerMin']"
        >
          {{ "user.list.errors.dateRange" | transloco }}
        </mat-error>
      </mat-form-field>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container mat-elevation-z8">
    <div class="loading-shade" *ngIf="loading$ | async">
      <mat-spinner diameter="48"></mat-spinner>
    </div>

    <table mat-table [dataSource]="dataSource" matSort>
      <!-- Profile Picture Column -->
      <ng-container matColumnDef="profilePicture">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let user">
          <img
            [src]="user.profilePictureUrl || 'assets/images/default-avatar.png'"
            [alt]="user.fullName"
            class="user-avatar"
          />
        </td>
      </ng-container>

      <!-- Full Name Column -->
      <ng-container matColumnDef="fullName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          {{ "user.list.columns.name" | transloco }}
        </th>
        <td mat-cell *matCellDef="let user">
          <div class="user-name">
            <span class="full-name">{{ user.fullName }}</span>
            <span class="nepali-name">{{ user.fullNameNepali }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Email Column -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          {{ "user.list.columns.email" | transloco }}
        </th>
        <td mat-cell *matCellDef="let user">{{ user.email }}</td>
      </ng-container>

      <!-- Office Post Column -->
      <ng-container matColumnDef="officePost">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          {{ "user.list.columns.post" | transloco }}
        </th>
        <td mat-cell *matCellDef="let user">{{ user.officePost }}</td>
      </ng-container>

      <!-- Ward Number Column -->
      <ng-container matColumnDef="wardNumber">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          {{ "user.list.columns.ward" | transloco }}
        </th>
        <td mat-cell *matCellDef="let user">
          {{ getWardLabel(user.wardNumber) }}
        </td>
      </ng-container>

      <!-- Permissions Column -->
      <ng-container matColumnDef="permissions">
        <th mat-header-cell *matHeaderCellDef>
          {{ "user.list.columns.permissions" | transloco }}
        </th>
        <td mat-cell *matCellDef="let user">
          <mat-chip-set>
            <mat-chip
              *ngFor="let label of getPermissionLabels(user.permissions)"
            >
              {{ label }}
            </mat-chip>
          </mat-chip-set>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>
          {{ "user.list.columns.status" | transloco }}
        </th>
        <td mat-cell *matCellDef="let user">
          <mat-chip-set>
            <mat-chip [color]="user.isActive ? 'primary' : 'warn'" highlighted>
              {{
                user.isActive
                  ? ("user.list.active" | transloco)
                  : ("user.list.inactive" | transloco)
              }}
            </mat-chip>
          </mat-chip-set>
        </td>
      </ng-container>

      <!-- Approval Status Column -->
      <ng-container matColumnDef="approvalStatus">
        <th mat-header-cell *matHeaderCellDef>
          {{ "user.list.columns.approvalStatus" | transloco }}
        </th>
        <td mat-cell *matCellDef="let user">
          <mat-chip-set>
            <mat-chip
              [color]="user.isApproved ? 'primary' : 'warn'"
              highlighted
            >
              {{
                user.isApproved
                  ? ("user.list.approved" | transloco)
                  : ("user.list.notApproved" | transloco)
              }}
            </mat-chip>
          </mat-chip-set>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let user">
          <button
            mat-icon-button
            [matMenuTriggerFor]="menu"
            aria-label="Actions"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="onEditUser(user.id)">
              <mat-icon>edit</mat-icon>
              <span>{{ "common.actions.edit" | transloco }}</span>
            </button>
            <button mat-menu-item (click)="onToggleStatus(user)">
              <mat-icon>{{
                user.isApproved ? "block" : "check_circle"
              }}</mat-icon>
              <span>{{
                (user.isApproved ? "user.list.disapprove" : "user.list.approve")
                  | transloco
              }}</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="onDeleteUser(user)" color="warn">
              <mat-icon color="warn">delete</mat-icon>
              <span class="text-warn">{{
                "common.actions.delete" | transloco
              }}</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator
      [length]="totalUsers$ | async"
      [pageSize]="10"
      [pageSizeOptions]="[5, 10, 25, 50]"
      [showFirstLastButtons]="true"
      (page)="loadUsers()"
    >
    </mat-paginator>
  </div>
</div>
