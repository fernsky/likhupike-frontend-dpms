<div class="create-page-container">
  <!-- Page title with back button -->
  <app-page-title
    icon="business"
    titleTranslationKey="cooperative.title.create"
    descriptionTranslationKey="cooperative.createSteps.description"
  >
    <app-base-button
      buttonType="text"
      icon="arrow_back"
      (clicked)="cancelCreation()"
      translationKey="common.actions.back"
    >
    </app-base-button>
  </app-page-title>

  <!-- Main content container -->
  <mat-card class="main-card">
    <mat-horizontal-stepper
      [linear]="true"
      #stepper
      [selectedIndex]="activeStep"
    >
      <!-- Step labels -->
      <mat-step
        *ngFor="let step of steps; let i = index"
        [completed]="step.completed"
      >
        <ng-template matStepLabel>{{
          getStepLabel(step.title) | transloco
        }}</ng-template>
      </mat-step>
    </mat-horizontal-stepper>

    <form [formGroup]="createForm" (ngSubmit)="onSubmit()">
      <!-- Step 1: Basic Information -->
      <div *ngIf="activeStep === 0" class="step-content">
        <app-form-section
          icon="info"
          [title]="'cooperative.sections.basicInfo' | transloco"
          [subtitle]="'cooperative.sections.basicInfoSubtitle' | transloco"
        >
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>{{ "cooperative.fields.code" | transloco }}</mat-label>
              <input
                matInput
                formControlName="code"
                placeholder="e.g. dairy-coop-123"
              />
              <mat-hint>{{ "cooperative.hints.code" | transloco }}</mat-hint>
              <mat-error *ngIf="createForm.get('code')?.hasError('required')">
                {{ "cooperative.errors.codeRequired" | transloco }}
              </mat-error>
              <mat-error *ngIf="createForm.get('code')?.hasError('pattern')">
                {{ "cooperative.errors.codePattern" | transloco }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.defaultLocale" | transloco
              }}</mat-label>
              <mat-select formControlName="defaultLocale">
                <mat-option
                  *ngFor="let locale of availableLocales"
                  [value]="locale"
                >
                  {{ locale === "en" ? "English" : "Nepali" }}
                </mat-option>
              </mat-select>
              <mat-error
                *ngIf="createForm.get('defaultLocale')?.hasError('required')"
              >
                {{ "cooperative.errors.localeRequired" | transloco }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ "cooperative.fields.type" | transloco }}</mat-label>
              <mat-select formControlName="type">
                <mat-option
                  *ngFor="let type of cooperativeTypes"
                  [value]="type"
                >
                  {{ "cooperative.types." + type.toLowerCase() | transloco }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="createForm.get('type')?.hasError('required')">
                {{ "cooperative.errors.typeRequired" | transloco }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ "cooperative.fields.ward" | transloco }}</mat-label>
              <input
                matInput
                type="number"
                formControlName="ward"
                min="1"
                max="50"
              />
              <mat-error *ngIf="createForm.get('ward')?.hasError('required')">
                {{ "cooperative.errors.wardRequired" | transloco }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.status" | transloco
              }}</mat-label>
              <mat-select formControlName="status">
                <mat-option
                  *ngFor="let status of cooperativeStatuses"
                  [value]="status"
                >
                  {{
                    "cooperative.statuses." + status.toLowerCase() | transloco
                  }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.establishedDate" | transloco
              }}</mat-label>
              <input
                matInput
                [matDatepicker]="picker"
                formControlName="establishedDate"
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>
          </div>
        </app-form-section>

        <app-form-section
          icon="contact_phone"
          [title]="'cooperative.sections.contact' | transloco"
        >
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.registrationNumber" | transloco
              }}</mat-label>
              <input matInput formControlName="registrationNumber" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.contactEmail" | transloco
              }}</mat-label>
              <input matInput formControlName="contactEmail" type="email" />
              <mat-error
                *ngIf="createForm.get('contactEmail')?.hasError('email')"
              >
                {{ "cooperative.errors.emailInvalid" | transloco }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.contactPhone" | transloco
              }}</mat-label>
              <input matInput formControlName="contactPhone" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.websiteUrl" | transloco
              }}</mat-label>
              <input
                matInput
                formControlName="websiteUrl"
                placeholder="https://example.com"
              />
              <mat-error
                *ngIf="createForm.get('websiteUrl')?.hasError('pattern')"
              >
                {{ "cooperative.errors.urlInvalid" | transloco }}
              </mat-error>
            </mat-form-field>
          </div>
        </app-form-section>

        <div class="step-actions">
          <app-base-button
            variant="secondary"
            size="large"
            icon="arrow_back"
            (click)="previousStep()"
          >
            {{ "common.actions.previous" | transloco }}
          </app-base-button>

          <app-base-button
            variant="primary"
            size="large"
            icon="arrow_forward"
            (click)="nextStep()"
          >
            {{ "common.actions.next" | transloco }}
          </app-base-button>
        </div>
      </div>

      <!-- Step 2: Translation -->
      <div
        *ngIf="activeStep === 1"
        class="step-content"
        formGroupName="translation"
      >
        <app-form-section
          icon="translate"
          [title]="'cooperative.sections.translation' | transloco"
        >
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.locale" | transloco
              }}</mat-label>
              <input matInput formControlName="locale" readonly />
              <mat-hint>{{
                "cooperative.hints.defaultLocaleTranslation" | transloco
              }}</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ "cooperative.fields.name" | transloco }}</mat-label>
              <input matInput formControlName="name" />
              <mat-error
                *ngIf="createForm.get('translation.name')?.hasError('required')"
              >
                {{ "cooperative.errors.nameRequired" | transloco }}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-grid">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{
                "cooperative.fields.description" | transloco
              }}</mat-label>
              <textarea
                matInput
                formControlName="description"
                rows="4"
              ></textarea>
            </mat-form-field>
          </div>

          <div class="form-grid">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{
                "cooperative.fields.location" | transloco
              }}</mat-label>
              <textarea matInput formControlName="location" rows="2"></textarea>
            </mat-form-field>
          </div>
        </app-form-section>

        <app-form-section
          icon="add_circle"
          [title]="'cooperative.sections.additionalInfo' | transloco"
        >
          <div class="form-grid">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{
                "cooperative.fields.services" | transloco
              }}</mat-label>
              <textarea matInput formControlName="services" rows="3"></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{
                "cooperative.fields.achievements" | transloco
              }}</mat-label>
              <textarea
                matInput
                formControlName="achievements"
                rows="3"
              ></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.operatingHours" | transloco
              }}</mat-label>
              <textarea
                matInput
                formControlName="operatingHours"
                rows="2"
              ></textarea>
            </mat-form-field>
          </div>
        </app-form-section>

        <app-form-section
          icon="search"
          [title]="'cooperative.sections.seo' | transloco"
        >
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.seoTitle" | transloco
              }}</mat-label>
              <input matInput formControlName="seoTitle" />
              <mat-hint align="end"
                >{{
                  createForm.get("translation.seoTitle")?.value?.length || 0
                }}/60</mat-hint
              >
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.status" | transloco
              }}</mat-label>
              <mat-select formControlName="status">
                <mat-option
                  *ngFor="let status of contentStatuses"
                  [value]="status"
                >
                  {{
                    "cooperative.contentStatus." + status.toLowerCase()
                      | transloco
                  }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{
                "cooperative.fields.seoDescription" | transloco
              }}</mat-label>
              <textarea
                matInput
                formControlName="seoDescription"
                rows="2"
              ></textarea>
              <mat-hint align="end"
                >{{
                  createForm.get("translation.seoDescription")?.value?.length ||
                    0
                }}/160</mat-hint
              >
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.seoKeywords" | transloco
              }}</mat-label>
              <input matInput formControlName="seoKeywords" />
              <mat-hint>{{
                "cooperative.hints.keywords" | transloco
              }}</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{
                "cooperative.fields.slugUrl" | transloco
              }}</mat-label>
              <input matInput formControlName="slugUrl" />
              <mat-hint>{{ "cooperative.hints.slug" | transloco }}</mat-hint>
            </mat-form-field>
          </div>
        </app-form-section>

        <div class="step-actions">
          <app-base-button
            variant="secondary"
            size="large"
            icon="arrow_back"
            (click)="previousStep()"
          >
            {{ "common.actions.previous" | transloco }}
          </app-base-button>

          <app-base-button
            variant="primary"
            size="large"
            icon="arrow_forward"
            (click)="nextStep()"
          >
            {{ "common.actions.next" | transloco }}
          </app-base-button>
        </div>
      </div>

      <!-- Step 3: Location -->
      <div *ngIf="activeStep === 2" class="step-content">
        <app-form-section
          icon="location_on"
          [title]="'cooperative.sections.location' | transloco"
          [subtitle]="'cooperative.location.mapInstructions' | transloco"
        >
          <div class="location-section">
            <div class="coordinate-inputs" formGroupName="point">
              <mat-form-field appearance="outline">
                <mat-label>{{
                  "cooperative.fields.latitude" | transloco
                }}</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="latitude"
                  step="0.000001"
                />
                <mat-error
                  *ngIf="
                    createForm.get('point.latitude')?.hasError('min') ||
                    createForm.get('point.latitude')?.hasError('max')
                  "
                >
                  {{ "cooperative.errors.invalidLatitude" | transloco }}
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>{{
                  "cooperative.fields.longitude" | transloco
                }}</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="longitude"
                  step="0.000001"
                />
                <mat-error
                  *ngIf="
                    createForm.get('point.longitude')?.hasError('min') ||
                    createForm.get('point.longitude')?.hasError('max')
                  "
                >
                  {{ "cooperative.errors.invalidLongitude" | transloco }}
                </mat-error>
              </mat-form-field>

              <app-base-button
                buttonType="raised"
                color="primary"
                icon="my_location"
                (clicked)="useCurrentLocation()"
                translationKey="cooperative.location.useCurrentLocation"
                class="location-button"
              >
              </app-base-button>
            </div>

            <div class="map-container">
              <!-- Map placeholder - would be replaced with actual map component -->
              <div class="map-placeholder">
                <div class="map-instructions">
                  <mat-icon>map</mat-icon>
                  <p>
                    {{ "cooperative.location.mapInstructions" | transloco }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </app-form-section>

        <div class="step-actions">
          <app-base-button
            variant="secondary"
            size="large"
            icon="arrow_back"
            (click)="previousStep()"
          >
            {{ "common.actions.previous" | transloco }}
          </app-base-button>

          <app-base-button
            variant="primary"
            size="large"
            icon="arrow_forward"
            (click)="nextStep()"
          >
            {{ "common.actions.next" | transloco }}
          </app-base-button>
        </div>
      </div>

      <!-- Step 4: Review -->
      <div *ngIf="activeStep === 3" class="step-content">
        <app-form-section
          icon="assessment"
          [title]="'cooperative.sections.review' | transloco"
        >
          <div class="review-container">
            <div class="review-section">
              <h3>{{ "cooperative.sections.basicInfo" | transloco }}</h3>
              <div class="review-grid">
                <div class="review-item">
                  <span class="review-label">{{
                    "cooperative.fields.code" | transloco
                  }}</span>
                  <span class="review-value">{{
                    createForm.get("code")?.value
                  }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">{{
                    "cooperative.fields.type" | transloco
                  }}</span>
                  <span class="review-value">{{
                    "cooperative.types." +
                      createForm.get("type")?.value?.toLowerCase() | transloco
                  }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">{{
                    "cooperative.fields.ward" | transloco
                  }}</span>
                  <span class="review-value">{{
                    createForm.get("ward")?.value
                  }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">{{
                    "cooperative.fields.establishedDate" | transloco
                  }}</span>
                  <span class="review-value">{{
                    createForm.get("establishedDate")?.value | date
                  }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">{{
                    "cooperative.fields.status" | transloco
                  }}</span>
                  <span class="review-value">{{
                    "cooperative.statuses." +
                      createForm.get("status")?.value?.toLowerCase() | transloco
                  }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">{{
                    "cooperative.fields.defaultLocale" | transloco
                  }}</span>
                  <span class="review-value">{{
                    createForm.get("defaultLocale")?.value === "en"
                      ? "English"
                      : "Nepali"
                  }}</span>
                </div>
              </div>
            </div>

            <div class="review-section">
              <h3>{{ "cooperative.sections.translation" | transloco }}</h3>
              <div class="review-grid">
                <div class="review-item full-width">
                  <span class="review-label">{{
                    "cooperative.fields.name" | transloco
                  }}</span>
                  <span class="review-value">{{
                    createForm.get("translation.name")?.value
                  }}</span>
                </div>
                <div
                  class="review-item full-width"
                  *ngIf="createForm.get('translation.description')?.value"
                >
                  <span class="review-label">{{
                    "cooperative.fields.description" | transloco
                  }}</span>
                  <span class="review-value">{{
                    createForm.get("translation.description")?.value
                  }}</span>
                </div>
              </div>
            </div>

            <div class="review-section">
              <h3>{{ "cooperative.sections.location" | transloco }}</h3>
              <div class="review-grid">
                <div class="review-item">
                  <span class="review-label">{{
                    "cooperative.fields.coordinates" | transloco
                  }}</span>
                  <span
                    class="review-value"
                    *ngIf="
                      createForm.get('point.latitude')?.value &&
                      createForm.get('point.longitude')?.value
                    "
                  >
                    {{
                      createForm.get("point.latitude")?.value | number: "1.6-6"
                    }},
                    {{
                      createForm.get("point.longitude")?.value | number: "1.6-6"
                    }}
                  </span>
                  <span
                    class="review-value no-value"
                    *ngIf="
                      !createForm.get('point.latitude')?.value ||
                      !createForm.get('point.longitude')?.value
                    "
                  >
                    {{ "cooperative.messages.noCoordinates" | transloco }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-errors" *ngIf="createForm.invalid">
            <mat-icon color="warn">warning</mat-icon>
            <p>{{ "cooperative.messages.formHasErrors" | transloco }}</p>
          </div>
        </app-form-section>

        <div class="step-actions final-actions">
          <app-base-button
            buttonType="text"
            icon="arrow_back"
            (clicked)="previousStep()"
            translationKey="common.actions.previous"
          >
          </app-base-button>

          <app-base-button
            buttonType="text"
            (clicked)="cancelCreation()"
            translationKey="common.actions.cancel"
          >
          </app-base-button>

          <app-base-button
            buttonType="raised"
            color="primary"
            icon="save"
            [disabled]="createForm.invalid"
            type="submit"
            translationKey="cooperative.actions.createCooperative"
          >
          </app-base-button>
        </div>
      </div>
    </form>
  </mat-card>

  <!-- Loading overlay -->
  <div class="loading-overlay" *ngIf="loading$ | async">
    <div class="loading-content">
      <mat-spinner [diameter]="50"></mat-spinner>
      <p>{{ "cooperative.messages.creating" | transloco }}</p>
    </div>
  </div>
</div>
